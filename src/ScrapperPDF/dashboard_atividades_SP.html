<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Atividades</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Estilos personalizados -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            overflow-x: hidden;
        }
        
        /* --- Layout do Sidebar --- */
        .wrapper { display: flex; width: 100%; min-height: 100vh; align-items: stretch; }
        #sidebar {
            min-width: 280px; max-width: 280px; background: #212529;
            color: #fff; transition: all 0.3s;
        }
        #sidebar.active { margin-left: -280px; }
        #sidebar .sidebar-header {
            padding: 20px; background: #343a40; text-align: center;
            font-size: 1.5rem; font-weight: 700;
        }
        #sidebar .sidebar-controls { padding: 20px; }
        #sidebar .control-group { margin-bottom: 1.5rem; }
        #sidebar label { color: #adb5bd; font-weight: 500; margin-bottom: 0.5rem; }
        #sidebar .form-select, #sidebar .form-control {
            background-color: #343a40; color: #fff; border-color: #495057;
        }
        #sidebar .form-select:focus, #sidebar .form-control:focus {
            background-color: #343a40; color: #fff; border-color: #0d6efd; box-shadow: none;
        }
        #sidebar .form-select option { background: #343a40; color: #fff; }

        /* --- Layout do Conteúdo --- */
        #content { width: 100%; padding: 20px; min-height: 100vh; transition: all 0.3s; }
        #sidebar-toggle { font-size: 1.5rem; }
        
        @media (max-width: 768px) {
            #sidebar { margin-left: -280px; }
            #sidebar.active { margin-left: 0; }
            #sidebar-toggle { display: block; }
        }

        /* --- Estilos dos Componentes --- */
        .card {
            border: none; border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .card-icon {
            padding: 1rem; border-radius: 50%; display: inline-flex;
            align-items: center; justify-content: center; margin-right: 1rem;
        }
        .card-icon i { font-size: 1.5rem; }
        .bg-primary-light { background-color: rgba(13, 110, 253, 0.1); color: #0d6efd; }
        .bg-success-light { background-color: rgba(25, 135, 84, 0.1); color: #198754; }
        
        .file-upload-wrapper button { width: 100%; }
        .file-upload-wrapper { position: relative; overflow: hidden; display: block; }
        .file-upload-wrapper input[type=file] {
            font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer;
        }
        .table-responsive { max-height: 550px; }
        #file-name {
            display: block; margin-top: 10px; color: #adb5bd; font-size: 0.875rem;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%;
            width: 50px; height: 50px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        #priorities-agenda-container .list-group-item {
             border-left-width: 4px; border-radius: 0.25rem; margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>

    <div id="loader-overlay" class="d-none"><div class="loader"></div></div>

    <div class="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar">
            <div class="sidebar-header"><h3>Controles</h3></div>
            <div class="sidebar-controls">
                <div class="control-group">
                    <label for="file-input">Arquivo</label>
                    <div class="file-upload-wrapper">
                        <button class="btn btn-primary" type="button"><i class="bi bi-upload me-2"></i> Carregar Excel</button>
                        <input type="file" id="file-input" accept=".xlsx, .xls">
                    </div>
                    <span id="file-name">Nenhum arquivo.</span>
                </div>
                
                <h5 class="mt-4 pt-2 border-top border-secondary">Filtros</h5>
                <div class="control-group">
                    <label for="sheet-selector">Visão por Aba</label>
                    <select id="sheet-selector" class="form-select" disabled><option>Carregue um arquivo</option></select>
                </div>
                <div class="control-group">
                    <label for="responsavel-filter">Responsável</label>
                    <select id="responsavel-filter" class="form-select" disabled><option>Todos</option></select>
                </div>
                <div class="control-group">
                    <label for="status-geral-filter">Status Geral</label>
                    <select id="status-geral-filter" class="form-select" disabled>
                        <option value="Todos">Todos</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Concluído">Concluído</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="ressalva-filter">Ressalvas</label>
                    <select id="ressalva-filter" class="form-select" disabled>
                        <option value="Todas">Todas</option>
                        <option value="Com Ressalvas">Com Ressalvas</option>
                        <option value="Sem Ressalvas">Sem Ressalvas</option>
                    </select>
                </div>
            </div>
        </nav>

        <!-- Page Content -->
        <div id="content">
            <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 p-2 rounded">
                <div class="container-fluid">
                    <button type="button" id="sidebar-toggle" class="btn btn-primary"><i class="bi bi-list"></i></button>
                    <h5 class="ms-3 my-0 fw-bold text-dark">Dashboard de Atividades</h5>
                </div>
            </nav>
            
            <div id="dashboard-content" class="d-none">
                <div class="row g-4 mb-4" id="stats-cards"></div>
                <div class="row g-4 mb-4">
                    <div class="col-lg-6">
                        <div class="card h-100">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title fw-bold">Atividades com/sem Ressalvas</h5>
                                <div class="flex-grow-1" style="position: relative; min-height: 300px;"><canvas id="ressalvasChart"></canvas></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card h-100">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title fw-bold">Atividades por Responsável</h5>
                                <div class="flex-grow-1" style="position: relative; min-height: 300px;"><canvas id="responsavelChart"></canvas></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-12">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title fw-bold mb-3">Agenda de Prioridades</h5>
                                <div id="priorities-agenda-container"></div>
                            </div>
                        </div>
                    </div>
                </div>

                 <div class="row g-4">
                    <div class="col-12">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title fw-bold">Detalhes da Atividade</h5>
                                <div id="data-table-container" class="table-responsive"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="initial-message" class="text-center p-5 bg-light rounded-3 mt-4">
                <i class="bi bi-file-earmark-spreadsheet" style="font-size: 4rem; color: #6c757d;"></i>
                <h3 class="mt-3">Aguardando arquivo...</h3>
                <p class="text-muted">Use o menu lateral para carregar um arquivo Excel.</p>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        // --- MODEL ---
        class DataModel {
            constructor() {
                this.allData = []; this.currentFilteredData = []; this.sheetNames = [];
            }

            parseDate(dateInput) {
                if (dateInput instanceof Date) {
                    const validDate = new Date(dateInput);
                    validDate.setHours(0, 0, 0, 0);
                    return isNaN(validDate.getTime()) ? null : validDate;
                }

                if (typeof dateInput !== 'string' || dateInput.trim() === '') {
                    return null;
                }

                const str = dateInput.trim();
                let date = null;

                // Tenta AAAA-MM-DD ou AAAA/MM/DD
                let parts = str.match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})$/);
                if (parts) {
                    // new Date(ano, mês - 1, dia)
                    date = new Date(parseInt(parts[1]), parseInt(parts[2]) - 1, parseInt(parts[3]));
                } else {
                    // Tenta DD/MM/AAAA ou DD-MM-AAAA
                    parts = str.match(/^(\d{1,2})[-/](\d{1,2})[-/](\d{4})$/);
                    if (parts) {
                        // new Date(ano, mês - 1, dia)
                        date = new Date(parseInt(parts[3]), parseInt(parts[2]) - 1, parseInt(parts[1]));
                    }
                }

                if (date && !isNaN(date.getTime())) {
                    date.setHours(0, 0, 0, 0);
                    return date;
                }
                
                return null;
            }

            calculateWorkdays(endDate) {
                if (!(endDate instanceof Date) || isNaN(endDate.getTime())) return null;

                let today = new Date();
                today.setHours(0, 0, 0, 0);

                let workdays = 0;
                let currentDate = new Date(today);
                
                if (endDate >= today) {
                     while (currentDate < endDate) {
                        const day = currentDate.getDay();
                        if (day !== 0 && day !== 6) workdays++;
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                } else {
                     while (currentDate > endDate) {
                        currentDate.setDate(currentDate.getDate() - 1);
                        const day = currentDate.getDay();
                        if (day !== 0 && day !== 6) workdays--;
                    }
                }
                return workdays;
            }

            async loadWorkbook(file) {
                this.allData = []; this.sheetNames = [];
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                this.sheetNames = workbook.SheetNames;
                this.sheetNames.forEach(name => {
                    const worksheet = workbook.Sheets[name];
                    const sheetData = XLSX.utils.sheet_to_json(worksheet, { raw: false, defval: "" });
                    sheetData.forEach(row => {
                        row.ORIGEM = name;
                        const endDate = this.parseDate(row['PREVISÃO DE TÉRMINO']);
                        row['DIAS ÚTEIS'] = endDate ? this.calculateWorkdays(endDate) : '';
                    });
                    this.allData.push(...sheetData);
                });
            }

            applyFilters({ sheet, responsible, status, ressalva }) {
                let data = [...this.allData];
                if (sheet && sheet !== 'Consolidado') data = data.filter(row => row.ORIGEM === sheet);
                if (responsible && responsible !== 'Todos') data = data.filter(row => row['RESPONSÁVEL'] === responsible);
                if (status === 'Pendente') data = data.filter(row => row.ORIGEM.toUpperCase().includes('PENDÊNCIAS'));
                if (status === 'Concluído') data = data.filter(row => row.ORIGEM.toUpperCase().includes('CONCLUÍDOS'));
                if (ressalva === 'Com Ressalvas') data = data.filter(row => row['OBSERVAÇÃO'] && row['OBSERVAÇÃO'].toLowerCase().includes('ressalva'));
                if (ressalva === 'Sem Ressalvas') data = data.filter(row => !row['OBSERVAÇÃO'] || !row['OBSERVAÇÃO'].toLowerCase().includes('ressalva'));
                this.currentFilteredData = data;
            }
            getStats() {
                const totalActivities = this.currentFilteredData.length;
                const comRessalvas = this.currentFilteredData.filter(r => r['OBSERVAÇÃO'] && r['OBSERVAÇÃO'].toLowerCase().includes('ressalva')).length;
                const responsibles = [...new Set(this.currentFilteredData.map(r => r['RESPONSÁVEL'] || 'Não atribuído'))].sort();
                const pendenteData = [], concluidoData = [];
                responsibles.forEach(resp => {
                    pendenteData.push(this.currentFilteredData.filter(r => r['RESPONSÁVEL'] === resp && r.ORIGEM.toUpperCase().includes('PENDÊNCIAS')).length);
                    concluidoData.push(this.currentFilteredData.filter(r => r['RESPONSÁVEL'] === resp && r.ORIGEM.toUpperCase().includes('CONCLUÍDOS')).length);
                });
                return { totalActivities, responsibleCount: new Set(this.currentFilteredData.map(r => r['RESPONSÁVEL']).filter(Boolean)).size, ressalvas: { comRessalvas, semRessalvas: totalActivities - comRessalvas }, responsiblesChart: { labels: responsibles, pendenteData, concluidoData } };
            }

            getCategorizedPriorities() {
                const today = new Date(); today.setHours(0,0,0,0);
                const next7Days = new Date(today); next7Days.setDate(today.getDate() + 7);
                const next30Days = new Date(today); next30Days.setDate(today.getDate() + 30);

                const categories = { overdue: [], today: [], next7days: [], next30days: [] };
                
                this.currentFilteredData
                    .filter(row => row.ORIGEM.toUpperCase().includes('PENDÊNCIAS') && row['PREVISÃO DE TÉRMINO'])
                    .forEach(row => {
                        const dueDate = this.parseDate(row['PREVISÃO DE TÉRMINO']);
                        if (!dueDate) return;

                        if (dueDate < today) categories.overdue.push(row);
                        else if (dueDate.getTime() === today.getTime()) categories.today.push(row);
                        else if (dueDate <= next7Days) categories.next7days.push(row);
                        else if (dueDate <= next30Days) categories.next30days.push(row);
                    });

                for(const category in categories) {
                    categories[category].sort((a, b) => this.parseDate(a['PREVISÃO DE TÉRMINO']) - this.parseDate(b['PREVISÃO DE TÉRMINO']));
                }
                return categories;
            }

            getUniqueResponsibles() { return [...new Set(this.allData.map(row => row['RESPONSÁVEL']).filter(Boolean))].sort(); }
        }

        // --- VIEW ---
        class DashboardView {
            constructor() {
                Object.assign(this, {
                    fileInput: document.getElementById('file-input'), fileNameEl: document.getElementById('file-name'),
                    sheetSelector: document.getElementById('sheet-selector'), responsavelFilter: document.getElementById('responsavel-filter'),
                    statusGeralFilter: document.getElementById('status-geral-filter'), ressalvaFilter: document.getElementById('ressalva-filter'),
                    dashboardContent: document.getElementById('dashboard-content'), initialMessage: document.getElementById('initial-message'),
                    statsCardsContainer: document.getElementById('stats-cards'), dataTableContainer: document.getElementById('data-table-container'),
                    prioritiesAgendaContainer: document.getElementById('priorities-agenda-container'),
                    ressalvasChartCanvas: document.getElementById('ressalvasChart'), responsavelChartCanvas: document.getElementById('responsavelChart'),
                    loaderOverlay: document.getElementById('loader-overlay'), sidebarToggle: document.getElementById('sidebar-toggle'),
                    sidebar: document.getElementById('sidebar'), ressalvasChart: null, responsavelChart: null
                });
            }

            toggleLoading(isLoading) { this.loaderOverlay.classList.toggle('d-none', !isLoading); }
            updateFileName(name) { this.fileNameEl.textContent = name; }
            
            renderFilterOptions(selectElement, options, firstOptionText) {
                selectElement.innerHTML = `<option value="${firstOptionText}">${firstOptionText}</option>`;
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt; option.textContent = opt;
                    selectElement.appendChild(option);
                });
                selectElement.disabled = false;
            }

            toggleDashboardVisibility(show) {
                this.dashboardContent.classList.toggle('d-none', !show);
                this.initialMessage.classList.toggle('d-none', show);
            }

            renderStatsCards(stats) {
                this.statsCardsContainer.innerHTML = `
                    <div class="col-sm-6 col-lg-4"><div class="card"><div class="card-body d-flex align-items-center">
                        <div class="card-icon bg-primary-light"><i class="bi bi-list-task"></i></div>
                        <div><h5 class="card-title fs-2 fw-bold mb-0">${stats.totalActivities}</h5><p class="card-text text-muted mb-0">Total de Atividades</p></div>
                    </div></div></div>
                     <div class="col-sm-6 col-lg-4"><div class="card"><div class="card-body d-flex align-items-center">
                        <div class="card-icon bg-success-light"><i class="bi bi-people-fill"></i></div>
                        <div><h5 class="card-title fs-2 fw-bold mb-0">${stats.responsibleCount}</h5><p class="card-text text-muted mb-0">Responsáveis Únicos</p></div>
                    </div></div></div>`;
            }

            renderPrioritiesAgenda(categories) {
                const categoryConfig = {
                    overdue: { title: 'Atrasadas', icon: 'bi-x-circle-fill', color: 'danger' },
                    today: { title: 'Para Hoje', icon: 'bi-arrow-right-circle-fill', color: 'primary' },
                    next7days: { title: 'Próximos 7 Dias', icon: 'bi-calendar-week-fill', color: 'info' },
                    next30days: { title: 'Próximos 30 Dias', icon: 'bi-calendar-month-fill', color: 'secondary' }
                };

                let agendaHtml = '<div class="row g-3">';
                for(const key in categories) {
                    const config = categoryConfig[key];
                    const tasks = categories[key];
                    agendaHtml += `
                        <div class="col-lg-3 col-md-6">
                            <h6 class="text-${config.color}"><i class="bi ${config.icon} me-2"></i>${config.title} (${tasks.length})</h6>
                            <div class="list-group" style="max-height: 250px; overflow-y: auto;">`;
                    if(tasks.length > 0) {
                        tasks.forEach(row => {
                            agendaHtml += `
                                <div class="list-group-item list-group-item-action border-${config.color}">
                                    <div class="d-flex w-100 justify-content-between">
                                        <p class="mb-1 small">${row['ATIVIDADES']}</p>
                                    </div>
                                    <small class="text-muted">${row['RESPONSÁVEL'] || 'N/D'} &bull; ${row['PREVISÃO DE TÉRMINO']}</small>
                                </div>`;
                        });
                    } else {
                        agendaHtml += '<div class="list-group-item"><small class="text-muted">Nenhuma atividade.</small></div>';
                    }
                    agendaHtml += '</div></div>';
                }
                agendaHtml += '</div>';
                this.prioritiesAgendaContainer.innerHTML = agendaHtml;
            }

            renderDataTable(data) {
                if (data.length === 0) {
                    this.dataTableContainer.innerHTML = '<p class="text-center text-muted mt-3">Nenhum dado para exibir.</p>';
                    return;
                }
                const desiredHeaders = ['ORIGEM', 'ATIVIDADES', 'RESPONSÁVEL', 'PREVISÃO DE TÉRMINO', 'DIAS ÚTEIS', 'TEMPO TOTAL', 'OBSERVAÇÃO'];
                const allHeadersInFile = Object.keys(data[0]);
                const headers = desiredHeaders.filter(h => allHeadersInFile.includes(h));
                const today = new Date(); today.setHours(0, 0, 0, 0);
                let table = '<table class="table table-striped table-hover table-sm">';
                table += '<thead class="table-dark sticky-top"><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead><tbody>';
                data.forEach(row => {
                    table += '<tr>';
                    headers.forEach(header => {
                        const value = row[header]; let className = '';
                        if (header === 'DIAS ÚTEIS') {
                            const dias = parseInt(value, 10); if (!isNaN(dias)) className = dias < 0 ? 'text-danger fw-bold' : 'text-success';
                        } else if (header === 'PREVISÃO DE TÉRMINO') {
                            const dateParts = String(value || '').split('-');
                            if (dateParts.length === 3) {
                                const previsto = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
                                if (!isNaN(previsto.getTime()) && previsto < today) className = 'text-danger fw-bold';
                            }
                        }
                        table += `<td class="${className}">${value || ''}</td>`;
                    });
                    table += '</tr>';
                });
                table += '</tbody></table>'; this.dataTableContainer.innerHTML = table;
            }

            renderPieChart(ressalvas) {
                if (this.ressalvasChart) this.ressalvasChart.destroy();
                this.ressalvasChart = new Chart(this.ressalvasChartCanvas, {
                    type: 'pie', data: { labels: ['Com Ressalvas', 'Sem Ressalvas'], datasets: [{ data: [ressalvas.comRessalvas, ressalvas.semRessalvas], backgroundColor: ['#ffc107', '#0d6efd'] }] },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
            renderBarChart(chartData) {
                if (this.responsavelChart) this.responsavelChart.destroy();
                this.responsavelChart = new Chart(this.responsavelChartCanvas, {
                    type: 'bar', data: { labels: chartData.labels, datasets: [{ label: 'Pendente', data: chartData.pendenteData, backgroundColor: '#dc3545' }, { label: 'Concluído', data: chartData.concluidoData, backgroundColor: '#198754' }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } }
                });
            }
            bindSidebarToggle() { this.sidebarToggle.addEventListener('click', () => this.sidebar.classList.toggle('active')); }
        }

        // --- CONTROLLER ---
        class AppController {
            constructor(model, view) { this.model = model; this.view = view; }
            init() {
                this.view.bindSidebarToggle();
                this.view.fileInput.addEventListener('change', this.handleFileSelect.bind(this));
                [this.view.sheetSelector, this.view.responsavelFilter, this.view.statusGeralFilter, this.view.ressalvaFilter]
                    .forEach(el => el.addEventListener('change', this.handleFilterChange.bind(this)));
            }
            async handleFileSelect(event) {
                const file = event.target.files[0]; if (!file) return;
                this.view.toggleLoading(true); this.view.updateFileName(file.name);
                try {
                    await this.model.loadWorkbook(file);
                    this.view.renderFilterOptions(this.view.sheetSelector, this.model.sheetNames, 'Consolidado');
                    this.view.renderFilterOptions(this.view.responsavelFilter, this.model.getUniqueResponsibles(), 'Todos');
                    this.view.statusGeralFilter.disabled = false; this.view.ressalvaFilter.disabled = false;
                    this.handleFilterChange();
                    this.view.toggleDashboardVisibility(true);
                } catch (error) {
                    console.error("Erro ao carregar o arquivo:", error); alert("Ocorreu um erro ao ler o arquivo.");
                    this.view.updateFileName("Falha ao carregar");
                } finally { this.view.toggleLoading(false); }
            }
            handleFilterChange() {
                this.model.applyFilters({
                    sheet: this.view.sheetSelector.value, responsible: this.view.responsavelFilter.value,
                    status: this.view.statusGeralFilter.value, ressalva: this.view.ressalvaFilter.value
                });
                this.updateDashboard();
            }
            updateDashboard() {
                const stats = this.model.getStats();
                const priorities = this.model.getCategorizedPriorities();
                this.view.renderStatsCards(stats);
                this.view.renderPrioritiesAgenda(priorities);
                this.view.renderDataTable(this.model.currentFilteredData);
                this.view.renderPieChart(stats.ressalvas);
                this.view.renderBarChart(stats.responsiblesChart);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new AppController(new DataModel(), new DashboardView()).init();
        });
    </script>
</body>
</html>

