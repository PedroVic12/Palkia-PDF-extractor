<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Atividades</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Estilos personalizados -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            overflow-x: hidden;
        }
        
        /* --- Layout do Sidebar --- */
        .wrapper { display: flex; width: 100%; min-height: 100vh; align-items: stretch; }
        #sidebar {
            min-width: 280px; max-width: 280px; background: #212529;
            color: #fff; transition: all 0.3s;
        }
        #sidebar.active { margin-left: -280px; }
        #sidebar .sidebar-header {
            padding: 20px; background: #343a40; text-align: center;
            font-size: 1.5rem; font-weight: 700;
        }
        #sidebar .sidebar-controls { padding: 20px; }
        #sidebar .control-group { margin-bottom: 1.5rem; }
        #sidebar label { color: #adb5bd; font-weight: 500; margin-bottom: 0.5rem; }
        #sidebar .form-select, #sidebar .form-control {
            background-color: #343a40; color: #fff; border-color: #495057;
        }
        #sidebar .form-select:focus, #sidebar .form-control:focus {
            background-color: #343a40; color: #fff; border-color: #0d6efd; box-shadow: none;
        }
        #sidebar .form-select option { background: #343a40; color: #fff; }

        /* --- Layout do Conteúdo --- */
        #content { width: 100%; padding: 20px; min-height: 100vh; transition: all 0.3s; }
        #sidebar-toggle { font-size: 1.5rem; }
        .navbar-nav .nav-link { font-weight: 500; cursor: pointer; }
        .navbar-nav .nav-link.active { color: #0d6efd; font-weight: 700; }
        
        @media (max-width: 768px) {
            #sidebar { margin-left: -280px; }
            #sidebar.active { margin-left: 0; }
            .navbar-title { display: none; }
        }

        /* --- Estilos dos Componentes --- */
        .card {
            border: none; border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .file-upload-wrapper button { width: 100%; }
        .file-upload-wrapper { position: relative; overflow: hidden; display: block; }
        .file-upload-wrapper input[type=file] {
            font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer;
        }
        .table-responsive { max-height: 550px; }
        #file-name {
            display: block; margin-top: 10px; color: #adb5bd; font-size: 0.875rem;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%;
            width: 50px; height: 50px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .calendar-day.has-activity { background-color: #cfe2ff; cursor: pointer; font-weight: bold; }
        .calendar-day.selected-day { background-color: #0d6efd; color: white; border-radius: 0.25rem; }
        #modal-activity-details .badge { font-size: 0.9em; }

        .table-resizable { border-collapse: separate; border-spacing: 0; table-layout: fixed; width: 100%; }
        .table-resizable > thead > tr > th { position: relative; }
        .resizer { position: absolute; top: 0; right: 0; width: 5px; cursor: col-resize; user-select: none; height: 100%; }
        
        /* --- Estilos Kanban e Matrizes --- */
        .kanban-column, .analysis-quadrant {
            background-color: #f8f9fa; border-radius: 0.5rem; padding: 10px;
            height: 100%; min-height: 200px; transition: background-color 0.2s;
        }
        .kanban-column.drag-over, .analysis-quadrant.drag-over { background-color: #d1e7dd; }
        .task-card {
            cursor: grab; background: #fff; border-left: 5px solid #6c757d;
            padding: 10px; margin-bottom: 8px; border-radius: 0.25rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .task-card:active { cursor: grabbing; }
        .analysis-quadrant { min-height: 250px; }
        .quadrant-title { font-weight: bold; border-bottom: 2px solid; padding-bottom: 5px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="loader-overlay" class="d-none"><div class="loader"></div></div>

    <div class="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar">
            <div class="sidebar-header"><h3>Controles</h3></div>
            <div class="sidebar-controls">
                <div class="control-group">
                    <label for="file-input">Arquivo</label>
                    <div class="file-upload-wrapper">
                        <button class="btn btn-primary" type="button"><i class="bi bi-upload me-2"></i> Carregar Excel</button>
                        <input type="file" id="file-input" accept=".xlsx, .xls">
                    </div>
                    <span id="file-name">Nenhum arquivo.</span>
                </div>
                <div class="control-group">
                    <button id="export-button" class="btn btn-success w-100" disabled><i class="bi bi-download me-2"></i> Exportar Dados</button>
                </div>
                
                <h5 class="mt-4 pt-2 border-top border-secondary">Filtros</h5>
                <div class="control-group">
                    <label for="sheet-selector">Visão por Aba</label>
                    <select id="sheet-selector" class="form-select" disabled><option>Carregue um arquivo</option></select>
                </div>
                <div class="control-group">
                    <label for="responsavel-filter">Responsável</label>
                    <select id="responsavel-filter" class="form-select" disabled><option>Todos</option></select>
                </div>
                <div class="control-group">
                    <label for="status-geral-filter">Status Geral</label>
                    <select id="status-geral-filter" class="form-select" disabled>
                        <option value="Todos">Todos</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Concluído">Concluído</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="ressalva-filter">Ressalvas</label>
                    <select id="ressalva-filter" class="form-select" disabled>
                        <option value="Todas">Todas</option>
                        <option value="Com Ressalvas">Com Ressalvas</option>
                        <option value="Sem Ressalvas">Sem Ressalvas</option>
                    </select>
                </div>
            </div>
        </nav>

        <!-- Page Content -->
        <div id="content">
            <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 p-2 rounded">
                <div class="container-fluid">
                    <button type="button" id="sidebar-toggle" class="btn btn-primary"><i class="bi bi-list"></i></button>
                    <h5 class="ms-3 my-0 fw-bold text-dark navbar-title">Dashboard de Atividades SP - ONS - PLC</h5>
                    <ul class="navbar-nav ms-auto d-flex flex-row">
                        <li class="nav-item"><a class="nav-link px-3" href="#" data-view="main-dashboard-view">Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link px-3" href="#" data-view="kanban-view">Agenda Kanban</a></li>
                        <li class="nav-item"><a class="nav-link px-3" href="#" data-view="eisenhower-view">Matriz Eisenhower</a></li>
                        <li class="nav-item"><a class="nav-link px-3" href="#" data-view="swot-view">Matriz SWOT</a></li>
                    </ul>
                </div>
            </nav>
            
            <div id="dashboard-content" class="d-none">
                <!-- VISTA: DASHBOARD PRINCIPAL -->
                <div id="main-dashboard-view" class="view-container">
                    <div class="row g-4 mb-4" id="stats-cards"></div>
                    <div class="row g-4 mb-4">
                        <div class="col-lg-4">
                            <div class="card h-100">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title fw-bold">Status Geral</h5>
                                    <div class="flex-grow-1" style="position: relative; min-height: 250px;"><canvas id="statusChart"></canvas></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card h-100">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title fw-bold">Atividades c/ Ressalva</h5>
                                    <div class="flex-grow-1" style="position: relative; min-height: 250px;"><canvas id="ressalvasChart"></canvas></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card h-100">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title fw-bold">Atividades por Responsável</h5>
                                    <div class="flex-grow-1" style="position: relative; min-height: 250px;"><canvas id="responsavelChart"></canvas></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row g-4">
                        <div class="col-12">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title fw-bold">Detalhes da Atividade</h5>
                                    <div id="data-table-container" class="table-responsive"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- VISTA: AGENDA KANBAN -->
                <div id="kanban-view" class="view-container d-none">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title fw-bold mb-3">Agenda de Prioridades (Arraste para Replanejar)</h5>
                            <div id="priorities-agenda-container"></div>
                        </div>
                    </div>
                </div>
                
                <!-- VISTA: MATRIZ EISENHOWER -->
                <div id="eisenhower-view" class="view-container d-none">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title fw-bold mb-3">Matriz de Eisenhower</h5>
                            <div id="eisenhower-matrix-container"></div>
                        </div>
                    </div>
                </div>

                <!-- VISTA: MATRIZ SWOT -->
                <div id="swot-view" class="view-container d-none">
                     <div class="card">
                        <div class="card-body">
                            <h5 class="card-title fw-bold mb-3">Matriz de Forças e Fraquezas (SWOT)</h5>
                            <div id="swot-matrix-container"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="initial-message" class="text-center p-5 bg-light rounded-3 mt-4">
                <i class="bi bi-file-earmark-spreadsheet" style="font-size: 4rem; color: #6c757d;"></i>
                <h3 class="mt-3">Aguardando arquivo...</h3>
                <p class="text-muted">Use o menu lateral para carregar um arquivo Excel ou recarregue para ver os dados salvos.</p>
            </div>
        </div>
    </div>
    
    <!-- Modal Calendário -->
    <div class="modal fade" id="calendarModal" tabindex="-1" aria-labelledby="calendarModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="calendarModalLabel">Timeline da Atividade</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <div id="calendar-container"></div>
              <hr>
              <div id="modal-activity-details" class="mt-3 p-3 bg-light rounded" style="max-height: 200px; overflow-y: auto;">Selecione um dia no calendário para ver os detalhes.</div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        // --- MODELO ---
        class DataModel {
            constructor() {
                this.allData = []; this.currentFilteredData = []; this.sheetNames = [];
            }

            parseDate(dateInput) {
                if (dateInput instanceof Date) { dateInput.setHours(0,0,0,0); return dateInput; }
                if (typeof dateInput !== 'string' || dateInput.trim() === '') return null;
                const str = dateInput.trim();
                let date = null;
                
                let parts = str.match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})$/);
                if (parts) { date = new Date(parseInt(parts[1]), parseInt(parts[2]) - 1, parseInt(parts[3])); } 
                else {
                    parts = str.match(/^(\d{1,2})[-/](\d{1,2})[-/](\d{4})$/);
                     if (parts) {
                        const p1 = parseInt(parts[1]), p2 = parseInt(parts[2]), year = parseInt(parts[3]);
                        if (p1 > 12) { date = new Date(year, p2 - 1, p1); } 
                        else { date = new Date(year, p2 - 1, p1); }
                    }
                }
                if (date && !isNaN(date.getTime())) { date.setHours(0, 0, 0, 0); return date; }
                return null;
            }

            formatDate(date) {
                if (!(date instanceof Date) || isNaN(date.getTime())) return '';
                return date.toLocaleDateString('pt-BR');
            }

            calculateWorkdays(endDate) {
                if (!(endDate instanceof Date) || isNaN(endDate.getTime())) return null;
                let today = new Date(); today.setHours(0, 0, 0, 0);
                let workdays = 0, currentDate = new Date(today);
                if (endDate >= today) {
                     while (currentDate < endDate) {
                        const day = currentDate.getDay(); if (day !== 0 && day !== 6) workdays++;
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                } else {
                     while (currentDate > endDate) {
                        currentDate.setDate(currentDate.getDate() - 1);
                        const day = currentDate.getDay(); if (day !== 0 && day !== 6) workdays--;
                    }
                }
                return workdays;
            }

            async loadWorkbook(file, existingData = []) {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                this.sheetNames = workbook.SheetNames;
                
                const analysisMap = new Map();
                existingData.forEach(row => {
                    if (row.ID) {
                        analysisMap.set(row.ID, { eisenhower: row.eisenhower, swot: row.swot });
                    }
                });

                this.allData = [];
                this.sheetNames.forEach(name => {
                    const worksheet = workbook.Sheets[name];
                    const sheetData = XLSX.utils.sheet_to_json(worksheet, { raw: false, defval: "" });
                    sheetData.forEach((row, index) => {
                        row.ID = `${name.replace(/\s/g, '')}-${index}`;
                        row.ORIGEM = name;
                        row.STATUS = name.toUpperCase().includes('CONCLUÍDOS') ? 'Concluído' : 'Pendente';
                        row.dueDate = this.parseDate(row['PREVISÃO DE TÉRMINO']);
                        row['PREVISÃO DE TÉRMINO_FORMATADA'] = this.formatDate(row.dueDate);
                        row['DIAS ÚTEIS'] = row.dueDate ? this.calculateWorkdays(row.dueDate) : '';
                        
                        const savedAnalysis = analysisMap.get(row.ID);
                        row.eisenhower = savedAnalysis ? savedAnalysis.eisenhower : 'unclassified';
                        row.swot = savedAnalysis ? savedAnalysis.swot : 'unclassified';
                    });
                    this.allData.push(...sheetData);
                });
            }

            updateActivityDate(activityId, newDate) {
                const activity = this.allData.find(a => a.ID === activityId);
                if (activity) {
                    activity.dueDate = newDate;
                    activity['PREVISÃO DE TÉRMINO'] = this.formatDate(newDate);
                    activity['PREVISÃO DE TÉRMINO_FORMATADA'] = this.formatDate(newDate);
                    activity['DIAS ÚTEIS'] = this.calculateWorkdays(newDate);
                    return true;
                }
                return false;
            }

            updateActivityAnalysis(activityId, type, category) {
                const activity = this.allData.find(a => a.ID === activityId);
                if (activity) {
                    activity[type] = category;
                    return true;
                }
                return false;
            }

            applyFilters({ sheet, responsible, status, ressalva }) {
                let data = [...this.allData];
                if (sheet && sheet !== 'Consolidado') data = data.filter(r => r.ORIGEM === sheet);
                if (responsible && responsible !== 'Todos') data = data.filter(r => r['RESPONSÁVEL'] === responsible);
                if (status === 'Pendente') data = data.filter(r => r.STATUS === 'Pendente');
                if (status === 'Concluído') data = data.filter(r => r.STATUS === 'Concluído');
                if (ressalva === 'Com Ressalvas') data = data.filter(r => r['OBSERVAÇÃO'] && String(r['OBSERVAÇÃO']).trim() !== '');
                if (ressalva === 'Sem Ressalvas') data = data.filter(r => !r['OBSERVAÇÃO'] || String(r['OBSERVAÇÃO']).trim() === '');
                this.currentFilteredData = data;
            }

            getStats() {
                const data = this.currentFilteredData;
                const total = data.length;
                const comRessalvas = data.filter(r => r['OBSERVAÇÃO'] && String(r['OBSERVAÇÃO']).trim() !== '').length;
                const statusCounts = { pendente: data.filter(r => r.STATUS === 'Pendente').length, concluido: data.filter(r => r.STATUS === 'Concluído').length };
                const respChartData = {};
                data.forEach(r => {
                    const resp = r['RESPONSÁVEL'] || 'Não atribuído';
                    if (!respChartData[resp]) respChartData[resp] = { 'Pendente': 0, 'Concluído': 0 };
                    respChartData[resp][r.STATUS]++;
                });
                return { total, responsibleCount: new Set(data.map(r => r['RESPONSÁVEL']).filter(Boolean)).size, ressalvas: { com: comRessalvas, sem: total - comRessalvas }, statusCounts, respChartData };
            }

            getCategorizedPriorities() {
                const today = new Date(); today.setHours(0,0,0,0);
                const categories = { overdue: [], today: [], next7days: [], next30days: [], future: [] };
                this.currentFilteredData.filter(r => r.STATUS === 'Pendente' && r.dueDate).forEach(row => {
                    const dueDate = row.dueDate;
                    if (dueDate < today) categories.overdue.push(row);
                    else if (dueDate.getTime() === today.getTime()) categories.today.push(row);
                    else if (dueDate <= new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000)) categories.next7days.push(row);
                    else if (dueDate <= new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000)) categories.next30days.push(row);
                    else categories.future.push(row);
                });
                for (const cat in categories) { categories[cat].sort((a, b) => a.dueDate - b.dueDate); }
                return categories;
            }

             getAnalysisData() {
                const data = {
                    eisenhower: { important_urgent: [], important_not_urgent: [], not_important_urgent: [], not_important_not_urgent: [], unclassified: [] },
                    swot: { strength: [], weakness: [], opportunity: [], threat: [], unclassified: [] }
                };
                this.currentFilteredData.filter(r => r.STATUS === 'Pendente').forEach(row => {
                    const eisenhowerCat = row.eisenhower || 'unclassified';
                    if (data.eisenhower[eisenhowerCat]) data.eisenhower[eisenhowerCat].push(row);
                    const swotCat = row.swot || 'unclassified';
                    if (data.swot[swotCat]) data.swot[swotCat].push(row);
                });
                return data;
            }

            getActivitiesForMonth(date) {
                const year = date.getFullYear(), month = date.getMonth();
                return this.currentFilteredData.filter(r => r.dueDate && r.dueDate.getFullYear() === year && r.dueDate.getMonth() === month);
            }

            getUniqueResponsibles() { return [...new Set(this.allData.map(r => r['RESPONSÁVEL']).filter(Boolean))].sort(); }
        }

        // --- VISÃO (View) ---
        class DashboardView {
            constructor() {
                Object.assign(this, {
                    loader: document.getElementById('loader-overlay'),
                    sidebar: document.getElementById('sidebar'),
                    sidebarToggle: document.getElementById('sidebar-toggle'),
                    fileNameEl: document.getElementById('file-name'),
                    sheetSelector: document.getElementById('sheet-selector'),
                    responsavelFilter: document.getElementById('responsavel-filter'),
                    statusGeralFilter: document.getElementById('status-geral-filter'),
                    ressalvaFilter: document.getElementById('ressalva-filter'),
                    dashboardContent: document.getElementById('dashboard-content'),
                    initialMessage: document.getElementById('initial-message'),
                    statsCardsContainer: document.getElementById('stats-cards'),
                    prioritiesAgendaContainer: document.getElementById('priorities-agenda-container'),
                    eisenhowerContainer: document.getElementById('eisenhower-matrix-container'),
                    swotContainer: document.getElementById('swot-matrix-container'),
                    dataTableContainer: document.getElementById('data-table-container'),
                    statusChartCanvas: document.getElementById('statusChart'),
                    ressalvasChartCanvas: document.getElementById('ressalvasChart'),
                    responsavelChartCanvas: document.getElementById('responsavelChart'),
                    exportButton: document.getElementById('export-button'),
                    charts: {}
                });
            }

            toggleLoading(show) { this.loader.classList.toggle('d-none', !show); }
            toggleDashboard(show) {
                this.dashboardContent.classList.toggle('d-none', !show);
                this.initialMessage.classList.toggle('d-none', show);
                document.querySelectorAll('.nav-link[data-view]').forEach(link => {
                    link.classList.toggle('disabled', !show);
                });
                this.exportButton.disabled = !show;
            }
            updateFileName(name) { this.fileNameEl.textContent = name; }

            populateFilters(sheetNames, responsibles) {
                this.sheetSelector.innerHTML = '<option>Consolidado</option>' + sheetNames.map(n => `<option>${n}</option>`).join('');
                this.responsavelFilter.innerHTML = '<option>Todos</option>' + responsibles.map(r => `<option>${r}</option>`).join('');
                [this.sheetSelector, this.responsavelFilter, this.statusGeralFilter, this.ressalvaFilter].forEach(el => el.disabled = false);
            }
            
            renderStatsCards({ total, responsibleCount }) {
                this.statsCardsContainer.innerHTML = `
                    <div class="col-sm-6 col-lg-6"><div class="card"><div class="card-body"><h5>Total de Atividades na Visão</h5><h2 class="fw-bold">${total}</h2></div></div></div>
                    <div class="col-sm-6 col-lg-6"><div class="card"><div class="card-body"><h5>Responsáveis Únicos na Visão</h5><h2 class="fw-bold">${responsibleCount}</h2></div></div></div>`;
            }

            renderPrioritiesAgenda(priorities, eventHandlers) {
                const config = {
                    overdue: { t: 'Atrasadas', i: 'bi-x-circle-fill', c: 'danger' },
                    today: { t: 'Para Hoje', i: 'bi-arrow-right-circle-fill', c: 'primary' },
                    next7days: { t: 'Próximos 7 Dias', i: 'bi-calendar-week-fill', c: 'info' },
                    next30days: { t: 'Próximos 30 Dias', i: 'bi-calendar-month-fill', c: 'secondary' }
                };
                let html = '<div class="row g-3">';
                for (const key in config) {
                    const { t, i, c } = config[key];
                    const tasks = priorities[key] || [];
                    html += `<div class="col-lg-3 col-md-6 d-flex flex-column">
                                <h6 class="text-${c}"><i class="bi ${i} me-2"></i>${t} (${tasks.length})</h6>
                                <div class="kanban-column flex-grow-1" data-category="${key}" style="min-height: 300px; max-height: 500px; overflow-y: auto;">`;
                    tasks.forEach(row => {
                        html += `<div class="task-card border-${c}" draggable="true" data-id="${row.ID}">
                                    <p class="mb-1 small fw-bold">${row['ATIVIDADES']}</p>
                                    <small class="text-muted">${row['RESPONSÁVEL'] || 'N/D'} &bull; ${row['PREVISÃO DE TÉRMINO_FORMATADA']}</small>
                                 </div>`;
                    });
                    html += '</div></div>';
                }
                this.prioritiesAgendaContainer.innerHTML = html + '</div>';
                this._addDragDropListeners(this.prioritiesAgendaContainer, '.kanban-column', '.task-card', eventHandlers);
            }

            _renderAnalysisMatrix(container, quadrants, data, eventHandlers) {
                let html = `<div class="row">
                    <div class="col-lg-9 col-md-8">
                        <div class="row g-3">`;
                quadrants.forEach(q => {
                    const items = data[q.id] || [];
                    html += `<div class="col-lg-6">
                                <div class="analysis-quadrant" data-category="${q.id}">
                                    <h6 class="quadrant-title" style="border-color: ${q.color}; color: ${q.color};">${q.title} (${items.length})</h6>
                                    <div class="tasks-container" style="max-height: 200px; overflow-y: auto;">
                                        ${items.map(item => `<div class="task-card" draggable="true" data-id="${item.ID}"><p class="mb-1 small">${item['ATIVIDADES']}</p></div>`).join('')}
                                    </div>
                                </div>
                             </div>`;
                });
                html += `</div></div>
                    <div class="col-lg-3 col-md-4">
                         <div class="analysis-quadrant bg-light" data-category="unclassified">
                            <h6 class="quadrant-title text-muted border-muted">Não Classificadas (${data.unclassified.length})</h6>
                             <div class="tasks-container" style="max-height: 450px; overflow-y: auto;">
                                ${data.unclassified.map(item => `<div class="task-card" draggable="true" data-id="${item.ID}"><p class="mb-1 small">${item['ATIVIDADES']}</p></div>`).join('')}
                            </div>
                        </div>
                    </div>
                </div>`;
                container.innerHTML = html;
                this._addDragDropListeners(container, '.analysis-quadrant', '.task-card', eventHandlers);
            }

            renderEisenhowerMatrix(data, eventHandlers) {
                const quadrants = [
                    { id: 'important_urgent', title: 'Fazer Agora', color: '#dc3545' }, { id: 'important_not_urgent', title: 'Agendar', color: '#ffc107' },
                    { id: 'not_important_urgent', title: 'Delegar', color: '#0dcaf0' }, { id: 'not_important_not_urgent', title: 'Eliminar', color: '#6c757d' },
                ];
                this._renderAnalysisMatrix(this.eisenhowerContainer, quadrants, data, eventHandlers);
            }

            renderSwotMatrix(data, eventHandlers) {
                 const quadrants = [
                    { id: 'strength', title: 'Forças', color: '#198754' }, { id: 'weakness', title: 'Fraquezas', color: '#dc3545' },
                    { id: 'opportunity', title: 'Oportunidades', color: '#0d6efd' }, { id: 'threat', title: 'Ameaças', color: '#ffc107' },
                ];
                 this._renderAnalysisMatrix(this.swotContainer, quadrants, data, eventHandlers);
            }

            _addDragDropListeners(container, columnSelector, itemSelector, { onDrop }) {
                const columns = container.querySelectorAll(columnSelector);
                const items = container.querySelectorAll(itemSelector);
                items.forEach(item => {
                    item.addEventListener('dragstart', e => {
                        e.dataTransfer.setData('text/plain', item.dataset.id);
                        setTimeout(() => item.classList.add('d-none'), 0);
                    });
                    item.addEventListener('dragend', () => item.classList.remove('d-none'));
                });
                columns.forEach(column => {
                    column.addEventListener('dragover', e => { e.preventDefault(); column.classList.add('drag-over'); });
                    column.addEventListener('dragleave', () => column.classList.remove('drag-over'));
                    column.addEventListener('drop', e => {
                        e.preventDefault(); column.classList.remove('drag-over');
                        onDrop(e.dataTransfer.getData('text/plain'), column.dataset.category);
                    });
                });
            }

            renderDataTable(data, onDateClick) {
                if (data.length === 0) { this.dataTableContainer.innerHTML = '<p class="text-center text-muted mt-3">Nenhum dado para exibir.</p>'; return; }
                const headers = ['ORIGEM', 'STATUS', 'ATIVIDADES', 'RESPONSÁVEL', 'PREVISÃO DE TÉRMINO', 'DIAS ÚTEIS', 'TEMPO TOTAL', 'OBSERVAÇÃO'];
                let tableHtml = '<table class="table table-striped table-hover table-sm table-resizable">';
                tableHtml += `<thead class="table-dark sticky-top"><tr>${headers.map(h => `<th>${h}<div class="resizer"></div></th>`).join('')}</tr></thead><tbody>`;
                data.forEach(row => {
                    tableHtml += `<tr>${headers.map(header => {
                        let value = '', className = '', extra = '';
                        if (header === 'PREVISÃO DE TÉRMINO') {
                            value = row['PREVISÃO DE TÉRMINO_FORMATADA'] || '';
                            if (value) { className = 'fw-bold date-cell'; extra = `data-activity-id='${row.ID}' style="cursor: pointer;" title="Clique para ver no calendário"`; if (row.STATUS === 'Pendente' && row.dueDate && row.dueDate < new Date().setHours(0,0,0,0)) className += ' table-danger'; }
                        } else { value = row[header] || ''; }
                        if (header === 'DIAS ÚTEIS' || header === 'TEMPO TOTAL') { const num = parseInt(value, 10); if (!isNaN(num) && num < 0) className = 'text-danger fw-bold'; }
                        return `<td class="${className}" ${extra}>${value}</td>`;
                    }).join('')}</tr>`;
                });
                this.dataTableContainer.innerHTML = tableHtml + '</tbody></table>';
                this.makeTableResizable();
                this.dataTableContainer.querySelectorAll('.date-cell').forEach(cell => {
                    if (cell.dataset.activityId) cell.addEventListener('click', () => onDateClick(cell.dataset.activityId));
                });
            }
            
            makeTableResizable() {
                this.dataTableContainer.querySelectorAll('th').forEach(header => {
                    const resizer = header.querySelector('.resizer');
                    if (!resizer) return;
                    const onMouseMove = e => { if (header.startWidth) header.style.width = `${header.startWidth + e.clientX - header.startX}px`; };
                    const onMouseUp = () => { header.startWidth = null; window.removeEventListener('mousemove', onMouseMove); window.removeEventListener('mouseup', onMouseUp); };
                    resizer.addEventListener('mousedown', e => {
                        e.preventDefault(); header.startX = e.clientX; header.startWidth = header.offsetWidth;
                        window.addEventListener('mousemove', onMouseMove); window.addEventListener('mouseup', onMouseUp);
                    });
                });
            }

            renderCharts(stats) {
                this._renderPieChart('statusChart', this.statusChartCanvas, ['Pendente', 'Concluído'], [stats.statusCounts.pendente, stats.statusCounts.concluido], ['#ffc107', '#198754']);
                this._renderPieChart('ressalvasChart', this.ressalvasChartCanvas, ['Com Ressalvas', 'Sem Ressalvas'], [stats.ressalvas.com, stats.ressalvas.sem], ['#dc3545', '#0d6efd']);
                this._renderBarChart('responsavelChart', this.responsavelChartCanvas, stats.respChartData);
            }

            _renderPieChart(id, canvas, labels, data, colors) {
                if (this.charts[id]) this.charts[id].destroy();
                this.charts[id] = new Chart(canvas, { type: 'pie', data: { labels, datasets: [{ data, backgroundColor: colors }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } } });
            }

            _renderBarChart(id, canvas, data) {
                if (this.charts[id]) this.charts[id].destroy();
                const labels = Object.keys(data);
                this.charts[id] = new Chart(canvas, { type: 'bar', data: { labels, datasets: [ { label: 'Pendente', data: labels.map(l => data[l].Pendente), backgroundColor: '#ffc107' }, { label: 'Concluído', data: labels.map(l => data[l].Concluído), backgroundColor: '#198754' } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } } });
            }

            switchView(targetViewId) {
                document.querySelectorAll('.view-container').forEach(div => div.classList.add('d-none'));
                document.getElementById(targetViewId).classList.remove('d-none');
                
                document.querySelectorAll('.nav-link[data-view]').forEach(item => item.classList.remove('active'));
                const activeLink = document.querySelector(`.nav-link[data-view="${targetViewId}"]`);
                if(activeLink) activeLink.classList.add('active');
            }
        }

        // --- CONTROLLER (App Logic) ---
        class AppController {
            constructor(model, view) {
                this.model = model; this.view = view;
                this.modal = new bootstrap.Modal(document.getElementById('calendarModal'));
                this.currentView = 'main-dashboard-view';
            }

            init() {
                this.view.toggleLoading(true);
                this.setupEventListeners();
                
                const savedData = localStorage.getItem('dashboardAppState');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        this.model.allData = parsed.allData.map(row => ({
                            ...row, 
                            dueDate: this.model.parseDate(row['PREVISÃO DE TÉRMINO_FORMATADA'])
                        }));
                        this.model.sheetNames = parsed.sheetNames;
                        this.view.updateFileName(parsed.fileName);
                        this.view.populateFilters(this.model.sheetNames, this.model.getUniqueResponsibles());
                        this.handleFilterChange(); 
                    } catch (e) {
                        console.error("Failed to load data from storage:", e);
                        localStorage.removeItem('dashboardAppState');
                    }
                }
                this.view.toggleLoading(false);
                this.view.toggleDashboard(this.model.allData.length > 0);
                this.view.switchView(this.currentView);
            }

            setupEventListeners() {
                document.getElementById('file-input').addEventListener('change', e => this.handleFileSelect(e));
                [this.view.sheetSelector, this.view.responsavelFilter, this.view.statusGeralFilter, this.view.ressalvaFilter]
                    .forEach(el => el.addEventListener('change', () => this.handleFilterChange()));
                this.view.sidebarToggle.addEventListener('click', () => this.view.sidebar.classList.toggle('active'));
                this.view.exportButton.addEventListener('click', () => this.handleExport());
                document.querySelectorAll('[data-view]').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.currentView = e.currentTarget.dataset.view;
                        this.updateDashboard(); 
                    });
                });
            }

            async handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;
                this.view.toggleLoading(true);
                this.view.updateFileName(file.name);
                await this.model.loadWorkbook(file, this.model.allData);
                
                this.saveState(file.name);
                this.view.populateFilters(this.model.sheetNames, this.model.getUniqueResponsibles());
                this.handleFilterChange();
                this.view.toggleLoading(false);
            }

            handleFilterChange() {
                this.model.applyFilters({
                    sheet: this.view.sheetSelector.value, responsible: this.view.responsavelFilter.value,
                    status: this.view.statusGeralFilter.value, ressalva: this.view.ressalvaFilter.value,
                });
                this.updateDashboard();
            }

            updateDashboard() {
                const stats = this.model.getStats();
                const priorities = this.model.getCategorizedPriorities();
                const analysisData = this.model.getAnalysisData();
                
                this.view.renderStatsCards(stats);
                this.view.renderCharts(stats);
                this.view.renderDataTable(this.model.currentFilteredData, id => this.handleDateClick(id));
                this.view.renderPrioritiesAgenda(priorities, { onDrop: (id, cat) => this.handleKanbanDrop(id, cat) });
                this.view.renderEisenhowerMatrix(analysisData.eisenhower, { onDrop: (id, cat) => this.handleAnalysisDrop(id, 'eisenhower', cat) });
                this.view.renderSwotMatrix(analysisData.swot, { onDrop: (id, cat) => this.handleAnalysisDrop(id, 'swot', cat) });
                
                this.view.switchView(this.currentView);
                this.view.toggleDashboard(this.model.allData.length > 0);
            }

            saveState(fileName = null) {
                try {
                    const currentFileName = fileName || JSON.parse(localStorage.getItem('dashboardAppState') || '{}').fileName;
                     localStorage.setItem('dashboardAppState', JSON.stringify({
                        allData: this.model.allData,
                        sheetNames: this.model.sheetNames,
                        fileName: currentFileName
                    }));
                } catch(e) { console.error("Error saving state: ", e); }
            }
            
            handleKanbanDrop(activityId, newCategory) {
                 const today = new Date(); today.setHours(0,0,0,0);
                 let newDate;
                 switch(newCategory) {
                    case 'today': newDate = today; break;
                    case 'next7days': newDate = new Date(today.getTime() + 4 * 24 * 60 * 60 * 1000); break;
                    case 'next30days': newDate = new Date(today.getTime() + 15 * 24 * 60 * 60 * 1000); break;
                    default: return;
                 }
                 if(this.model.updateActivityDate(activityId, newDate)) {
                    this.saveState();
                    this.updateDashboard();
                 }
            }

            handleAnalysisDrop(activityId, type, category) {
                if (this.model.updateActivityAnalysis(activityId, type, category)) {
                    this.saveState();
                    this.updateDashboard();
                }
            }

            handleExport() {
                this.view.toggleLoading(true);
                try {
                    const dataToExport = this.model.allData.map(row => {
                        const { ID, dueDate, ...rest } = row;
                        return { ...rest, 'Análise Eisenhower': row.eisenhower, 'Análise SWOT': row.swot };
                    });
                    const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Dados_Dashboard");
                    XLSX.writeFile(workbook, "Dashboard_Dados_Atualizados.xlsx");
                } catch(e) { console.error("Error exporting data:", e); }
                this.view.toggleLoading(false);
            }
            
            handleDateClick(activityId) {
                const activity = this.model.allData.find(a => a.ID === activityId);
                if (!activity || !activity.dueDate) return;
                
                const activitiesInMonth = this.model.getActivitiesForMonth(activity.dueDate);
                this.renderCalendarModal(activity.dueDate, activitiesInMonth);
                this.modal.show();
            }
            
            renderCalendarModal(date, activities) {
                const calendarContainer = document.getElementById('calendar-container');
                const detailsContainer = document.getElementById('modal-activity-details');
                const render = (day) => {
                    calendarContainer.innerHTML = this.generateCalendarHTML(date, activities, day);
                    calendarContainer.querySelectorAll('.has-activity').forEach(cell => {
                        cell.addEventListener('click', e => render(parseInt(e.currentTarget.textContent)) );
                    });
                    this.updateModalDetails(detailsContainer, activities.filter(a => a.dueDate.getDate() === day));
                }
                render(date.getDate());
            }
            
            generateCalendarHTML(date, activitiesForMonth, selectedDay) {
                const month = date.getMonth(), year = date.getFullYear();
                const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                const dayNames = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];
                const firstDayOfMonth = new Date(year, month, 1).getDay(), daysInMonth = new Date(year, month + 1, 0).getDate();
                let html = `<h4 class="text-center mb-3">${monthNames[month]} de ${year}</h4>`;
                html += '<table class="table table-bordered text-center"><thead><tr>' + dayNames.map(d => `<th>${d}</th>`).join('') + '</tr></thead><tbody>';
                let day = 1;
                for (let i = 0; i < 6; i++) {
                    html += '<tr>';
                    for (let j = 0; j < 7; j++) {
                        if (i === 0 && j < firstDayOfMonth || day > daysInMonth) { html += '<td></td>'; } 
                        else {
                            let cellClass = 'calendar-day';
                            if (activitiesForMonth.some(a => a.dueDate.getDate() === day)) {
                                cellClass += ' has-activity';
                                if (day === selectedDay) { cellClass += ' selected-day'; }
                            }
                            html += `<td class="${cellClass}">${day++}</td>`;
                        }
                    } html += '</tr>'; if (day > daysInMonth) break;
                }
                return html + '</tbody></table>';
            }
            
            updateModalDetails(container, activities) {
                if (!activities || activities.length === 0) { container.innerHTML = 'Selecione um dia com atividades.'; return; }
                container.innerHTML = activities.map((activity, index) => `${index > 0 ? '<hr>' : ''}
                    <p class="mb-1"><strong>Atividade:</strong> ${activity['ATIVIDADES']}</p>
                    <div class="d-flex justify-content-between flex-wrap">
                        <p class="mb-1 me-3"><strong>Responsável:</strong> ${activity['RESPONSÁVEL'] || 'N/D'}</p>
                        <p class="mb-1 me-3"><strong>Status:</strong> <span class="badge ${activity.STATUS === 'Concluído' ? 'bg-success' : 'bg-warning text-dark'}">${activity.STATUS}</span></p>
                        <p class="mb-1 me-3"><strong>Dias Úteis:</strong> ${activity['DIAS ÚTEIS']}</p>
                        <p class="mb-1"><strong>Tempo Total:</strong> ${activity['TEMPO TOTAL'] || 'N/A'}</p>
                    </div>
                    <p class="mb-0 mt-2"><strong>Observação:</strong> ${activity['OBSERVAÇÃO'] || 'N/A'}</p>`).join('');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const model = new DataModel();
            const view = new DashboardView();
            const controller = new AppController(model, view);
            controller.init();
        });
    </script>
</body>
</html>

